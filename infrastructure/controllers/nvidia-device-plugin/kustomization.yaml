apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: gpu-device-plugin
resources:
  - namespace.yaml
  - runtime.yaml
  - nvidia-device-plugin.yml
  # - nvidia-test-pod.yaml
helmCharts:
# Comment out or remove the helmCharts section
# - name: nvidia-device-plugin
#   repo: https://nvidia.github.io/k8s-device-plugin
#   version: 0.17.1
#   releaseName: nvidia-device-plugin
#   namespace: gpu-device-plugin
#   includeCRDs: true
#   valuesInline:
#     runtimeClassName: nvidia

# If the static nvidia-device-plugin.yml doesn't specify a namespace,
# or if it specifies a different one (e.g., kube-system),
# you might need a patch to set the namespace for the DaemonSet.
# However, the top-level 'namespace: gpu-device-plugin' in this kustomization
# should handle this for resources defined within nvidia-device-plugin.yml
# that don't explicitly set their own namespace.

# If the DaemonSet in nvidia-device-plugin.yml needs to use the 'nvidia' RuntimeClass,
# ensure its Pod template specifies 'runtimeClassName: nvidia'.
# If not, you can add a patch here:
patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: nvidia-device-plugin-daemonset
      namespace: gpu-device-plugin
    spec:
      template:
        spec:
          runtimeClassName: nvidia
          # Ensure tolerations for NVIDIA GPUs are present if needed,
          # often they are included in the official static manifest.
          # Example:
          # tolerations:
          # - key: nvidia.com/gpu
          #   operator: Exists
          #   effect: NoSchedule

apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
  namespace: cloudnative-pg
spec:
  instances: 1
  # PostgreSQL configuration
  postgresql:
    parameters:
      shared_buffers: 256MB
      max_connections: "100"
  # Storage configuration
  storage:
    size: 100Gi
    storageClass: local-storage
  # Bootstrap configuration
  bootstrap:
    initdb:
      database: postgres
      owner: postgres
      secret:
        name: postgres-superuser-secret
      postInitSQL:
        # Create databases
        - CREATE DATABASE immich;
        - CREATE DATABASE testdb;
        # Create users and grant permissions
        - DO $$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'immich') THEN CREATE USER immich; END IF; IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'demoapp') THEN CREATE USER demoapp; END IF; END $$;
        # Grant permissions
        - GRANT ALL PRIVILEGES ON DATABASE immich TO immich;
        - GRANT ALL PRIVILEGES ON DATABASE testdb TO demoapp;
        # Extensions
        - CREATE EXTENSION IF NOT EXISTS citext;
  # Monitoring configuration
  monitoring:
    enablePodMonitor: true

# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.10.1
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.33.0
clusterName: proxmox-talos-cluster
endpoint: https://192.168.10.199:6443
clusterPodNets:
  - 10.14.0.0/16
clusterSvcNets:
  - 10.15.0.0/16
additionalApiServerCertSans:
  - 192.168.10.199
  - 127.0.0.1
additionalMachineCertSans:
  - 192.168.10.199
  - 127.0.0.1
nodes:
  - hostname: talos-cluster-control-00
    controlPlane: true
    ipAddress: 192.168.10.100
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:C4:D7:F6"
        dhcp: false
        addresses:
          - 192.168.10.100/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
        vip:
          ip: 192.168.10.199
  - hostname: talos-cluster-control-01
    controlPlane: true
    ipAddress: 192.168.10.101
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:83:35:A4"
        dhcp: false
        addresses:
          - 192.168.10.101/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
        vip:
          ip: 192.168.10.199
  - hostname: talos-cluster-control-02
    controlPlane: true
    ipAddress: 192.168.10.102
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:C8:69:8F"
        dhcp: false
        addresses:
          - 192.168.10.102/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
        vip:
          ip: 192.168.10.199
  - hostname: talos-cluster-gpu-worker-00
    controlPlane: false
    ipAddress: 192.168.10.200
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:6E:A6:4C"
        dhcp: false
        addresses:
          - 192.168.10.200/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    # Use the GPU worker-specific configuration
    nodeLabels:
      node-type: gpu-worker
    patches:
      - |-
        machine:
          udev:
            rules:
              - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
              - SUBSYSTEM=="drm", KERNEL=="card*", GROUP="44", MODE="0660"
          kernel:
            modules:
              - name: nvidia
              - name: nvidia_uvm
              - name: nvidia_drm
              - name: nvidia_modeset
          sysctls:
            net.core.bpf_jit_harden: 1
  - hostname: talos-cluster-worker-01
    controlPlane: false
    ipAddress: 192.168.10.201
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:11:6B:0F"
        dhcp: false
        addresses:
          - 192.168.10.201/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    nodeLabels:
      node-type: worker
  - hostname: talos-cluster-worker-02
    controlPlane: false
    ipAddress: 192.168.10.203 # Corrected IP from .202
    installDisk: /dev/sda
    talosImageURL: factory.talos.dev/nocloud-installer/8bb934255e55fb23f861b102771e52ef616fb577a5d512870910df6abe0c573e:v1.10.1
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "BC:24:11:5E:5C:1D"
        dhcp: false
        addresses:
          - 192.168.10.203/24 # Use corrected IP
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.10.1
    nodeLabels:
      node-type: worker
patches:
  # Force nameserver
  - |-
    machine:
      network:
        nameservers:
          - 1.1.1.1
          - 1.0.0.1
  # Configure NTP
  - |-
    machine:
      time:
        disabled: false
        servers: ["time.cloudflare.com"]
  # Add Longhorn system extensions (iscsi-tools, util-linux)
  - |-
    machine:
      files:
        - content: |
            siderolabs/iscsi-tools
            siderolabs/util-linux-tools
          path: /var/lib/extensions/enabled_extensions
          permissions: 0600
  # Configure Longhorn storage volume
  - |-
    apiVersion: v1alpha1
    kind: UserVolumeConfig
    name: longhorn
    provisioning:
      diskSelector:
        match: disk.dev_path == '/dev/sdb'
      minSize: 10GB
controlPlane:
  patches:
    # Cluster configuration
    - |-
      cluster:
        # allowSchedulingOnControlPlanes: true
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        proxy:
          disabled: true
        network:
          cni:
            name: none
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
worker:
  patches:
    # Longhorn configuration for all worker nodes
    - |-
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/mnt/longhorn
              options:
                - bind
                - rshared
                - rw
